<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spin the Wheel</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; padding: 0; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    function SpinTheWheel() {
      const [names, setNames] = useState([]);
      const [currentName, setCurrentName] = useState('');
      const [isSpinning, setIsSpinning] = useState(false);
      const [rotation, setRotation] = useState(0);
      const [winner, setWinner] = useState(null);
      const [sheetUrl, setSheetUrl] = useState('');
      const [showSetup, setShowSetup] = useState(false);
      const [isLoading, setIsLoading] = useState(false);
      const canvasRef = useRef(null);

      useEffect(() => {
        const saved = localStorage.getItem('wheelSheetUrl');
        if (saved) setSheetUrl(saved);
      }, []);

      useEffect(() => {
        drawWheel();
      }, [names, rotation]);

      const colors = [
        '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', 
        '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2',
        '#F8B739', '#52B788', '#E07A5F', '#81B29A'
      ];

      const drawWheel = () => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = 180;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (names.length === 0) {
          ctx.fillStyle = '#E5E7EB';
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
          ctx.fill();
          ctx.fillStyle = '#6B7280';
          ctx.font = '16px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('Add names to start', centerX, centerY);
          return;
        }

        const sliceAngle = (2 * Math.PI) / names.length;

        names.forEach((name, i) => {
          const startAngle = i * sliceAngle + (rotation * Math.PI / 180);
          const endAngle = startAngle + sliceAngle;

          ctx.fillStyle = colors[i % colors.length];
          ctx.beginPath();
          ctx.moveTo(centerX, centerY);
          ctx.arc(centerX, centerY, radius, startAngle, endAngle);
          ctx.closePath();
          ctx.fill();

          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 2;
          ctx.stroke();

          ctx.save();
          ctx.translate(centerX, centerY);
          ctx.rotate(startAngle + sliceAngle / 2);
          ctx.textAlign = 'center';
          ctx.fillStyle = '#fff';
          ctx.font = 'bold 14px sans-serif';
          const displayName = name.length > 15 ? name.substring(0, 13) + '...' : name;
          ctx.fillText(displayName, radius * 0.65, 5);
          ctx.restore();
        });

        ctx.fillStyle = '#1F2937';
        ctx.beginPath();
        ctx.arc(centerX, centerY, 20, 0, 2 * Math.PI);
        ctx.fill();

        ctx.fillStyle = '#EF4444';
        ctx.beginPath();
        ctx.moveTo(centerX + radius + 10, centerY);
        ctx.lineTo(centerX + radius - 20, centerY - 15);
        ctx.lineTo(centerX + radius - 20, centerY + 15);
        ctx.closePath();
        ctx.fill();
      };

      const spinWheel = () => {
        if (names.length === 0 || isSpinning) return;

        setIsSpinning(true);
        setWinner(null);

        const spinDuration = 4000;
        const minSpins = 5;
        const extraRotation = Math.random() * 360;
        const totalRotation = minSpins * 360 + extraRotation;

        const startTime = Date.now();
        
        const animate = () => {
          const elapsed = Date.now() - startTime;
          const progress = Math.min(elapsed / spinDuration, 1);
          
          const easeOut = 1 - Math.pow(1 - progress, 3);
          const currentRotation = rotation + totalRotation * easeOut;
          
          setRotation(currentRotation % 360);

          if (progress < 1) {
            requestAnimationFrame(animate);
          } else {
            setIsSpinning(false);
            const finalRotation = currentRotation % 360;
            const sliceAngle = 360 / names.length;
            const pointerAngle = 360;
            const adjustedAngle = (360 - finalRotation + pointerAngle) % 360;
            const winnerIndex = Math.floor(adjustedAngle / sliceAngle) % names.length;
            setWinner(names[winnerIndex]);
          }
        };

        animate();
      };

      const loadFromSheet = async () => {
        if (!sheetUrl) {
          alert('Please configure Google Sheet URL first in Setup');
          return;
        }

        setIsLoading(true);
        try {
          const sheetId = extractSheetId(sheetUrl);
          console.log('Sheet ID:', sheetId);
          
          const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json`;
          console.log('Fetching from:', url);
          
          const response = await fetch(url);
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const text = await response.text();
          console.log('Response received, length:', text.length);
          
          const json = JSON.parse(text.substring(47).slice(0, -2));
          console.log('Full JSON:', json);
          
          // Get ALL rows
          const allRows = json.table.rows;
          console.log('Total rows:', allRows.length);
          
          // Log each row to see what we have
          allRows.forEach((row, idx) => {
            const value = row.c && row.c[0] ? row.c[0].v : '(empty)';
            console.log(`Row ${idx}: "${value}"`);
          });
          
          // Extract names - skip row 0 (header), get everything else
          const loadedNames = allRows
            .slice(1)  // Skip first row (header)
            .map(row => {
              if (!row.c || !row.c[0]) return null;
              return row.c[0].v;
            })
            .filter(name => {
              // Keep if it's not null, not empty after trim, and not literally "Name"
              return name !== null && 
                     name !== undefined && 
                     String(name).trim() !== '' && 
                     String(name).trim().toLowerCase() !== 'name';
            })
            .map(name => String(name).trim()); // Clean up whitespace
          
          console.log('Filtered names:', loadedNames);
          
          if (loadedNames.length === 0) {
            alert('No names found!\n\nMake sure:\nâ€¢ Sheet is public (Anyone with link â†’ Viewer)\nâ€¢ Cell A1 has "Name"\nâ€¢ Names are in column A starting from A2\nâ€¢ At least one name exists');
          } else {
            alert(`âœ… Successfully loaded ${loadedNames.length} names!`);
            setNames(loadedNames);
            setWinner(null);
          }
        } catch (error) {
          console.error('Error details:', error);
          alert(`âŒ Error loading from sheet:\n${error.message}\n\nChecklist:\nâ€¢ Is the sheet public?\nâ€¢ Is the URL correct?\nâ€¢ Are names in column A?`);
        }
        setIsLoading(false);
      };

      const extractSheetId = (url) => {
        const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
        return match ? match[1] : url;
      };

      const saveSheetUrl = () => {
        if (!sheetUrl) {
          alert('Please enter a Google Sheet URL');
          return;
        }
        localStorage.setItem('wheelSheetUrl', sheetUrl);
        setShowSetup(false);
        alert('âœ… Sheet URL saved!\n\nNow click "Refresh Names" to load entries.');
      };

      const addName = () => {
        if (currentName.trim()) {
          setNames([...names, currentName.trim()]);
          setCurrentName('');
          setWinner(null);
        }
      };

      const handleKeyPress = (e) => {
        if (e.key === 'Enter') {
          addName();
        }
      };

      const removeName = (index) => {
        setNames(names.filter((_, i) => i !== index));
        setWinner(null);
      };

      const clearAll = () => {
        if (window.confirm('Clear all names from the wheel?')) {
          setNames([]);
          setWinner(null);
        }
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-indigo-500 to-purple-600 p-4">
          <div className="max-w-6xl mx-auto">
            <div className="flex justify-between items-center mb-8 flex-wrap gap-4">
              <h1 className="text-4xl font-bold text-white flex items-center gap-3">
                ğŸ† Spin the Wheel
              </h1>
              <button
                onClick={() => setShowSetup(!showSetup)}
                className="bg-white text-indigo-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition font-semibold shadow-lg"
              >
                âš™ï¸ {showSetup ? 'Close' : 'Setup'}
              </button>
            </div>

            {showSetup && (
              <div className="bg-white rounded-2xl shadow-2xl p-6 mb-6">
                <h2 className="text-2xl font-bold text-gray-800 mb-4">Google Sheets Configuration</h2>
                
                <div className="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4 rounded">
                  <p className="text-sm text-blue-900 font-semibold mb-2">ğŸ“‹ Setup Checklist:</p>
                  <ul className="text-sm text-blue-800 space-y-1 list-disc ml-5">
                    <li>Open your Google Sheet</li>
                    <li>Click Share â†’ "Anyone with the link" â†’ Viewer</li>
                    <li>Cell A1 should contain "Name"</li>
                    <li>Names should be in column A starting from A2</li>
                    <li>Copy the sheet URL from your browser's address bar</li>
                  </ul>
                </div>

                <div className="space-y-3">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      ğŸ“Š Google Sheet URL:
                    </label>
                    <input
                      type="text"
                      value={sheetUrl}
                      onChange={(e) => setSheetUrl(e.target.value)}
                      placeholder="https://docs.google.com/spreadsheets/d/..."
                      className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none text-sm"
                    />
                  </div>
                  
                  <button
                    onClick={saveSheetUrl}
                    className="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-semibold shadow-lg"
                  >
                    ğŸ’¾ Save Configuration
                  </button>
                </div>

                <div className="mt-4 bg-purple-50 border-l-4 border-purple-500 p-4 rounded">
                  <p className="text-sm text-purple-900">
                    <strong>ğŸ“± Entry Form URL:</strong><br/>
                    <a href="https://esando16.github.io/spin-wheel-entry/" target="_blank" className="text-purple-600 underline break-all hover:text-purple-800">
                      https://esando16.github.io/spin-wheel-entry/
                    </a>
                  </p>
                </div>
              </div>
            )}

            <div className="grid lg:grid-cols-3 gap-6">
              <div className="lg:col-span-2 bg-white rounded-2xl shadow-2xl p-8">
                <div className="flex flex-col items-center">
                  <canvas
                    ref={canvasRef}
                    width={400}
                    height={400}
                    className="mb-6"
                  />
                  
                  <div className="flex gap-3 flex-wrap justify-center">
                    <button
                      onClick={loadFromSheet}
                      disabled={isLoading || !sheetUrl}
                      className="bg-blue-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition shadow-lg flex items-center gap-2"
                    >
                      <span className={isLoading ? 'animate-spin' : ''}>ğŸ”„</span>
                      {isLoading ? 'Loading...' : 'Refresh Names'}
                    </button>
                    
                    <button
                      onClick={spinWheel}
                      disabled={isSpinning || names.length === 0}
                      className="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-8 py-3 rounded-full font-bold text-lg hover:from-green-600 hover:to-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition shadow-lg"
                    >
                      {isSpinning ? 'ğŸ¡ Spinning...' : 'ğŸ¯ SPIN!'}
                    </button>
                  </div>

                  {winner && (
                    <div className="mt-6 bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-8 py-4 rounded-xl text-center shadow-2xl animate-bounce">
                      <p className="text-sm font-semibold">ğŸ‰ WINNER ğŸ‰</p>
                      <p className="text-3xl font-bold mt-1">{winner}</p>
                    </div>
                  )}
                </div>
              </div>

              <div className="space-y-6">
                <div className="bg-white rounded-2xl shadow-2xl p-6">
                  <h2 className="text-xl font-bold text-gray-800 mb-4">âœï¸ Quick Add</h2>
                  <div className="flex gap-2">
                    <input
                      type="text"
                      value={currentName}
                      onChange={(e) => setCurrentName(e.target.value)}
                      onKeyPress={handleKeyPress}
                      placeholder="Enter name..."
                      className="flex-1 px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none"
                      maxLength={30}
                    />
                    <button
                      onClick={addName}
                      className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition font-semibold"
                    >
                      Add
                    </button>
                  </div>
                  <p className="text-xs text-gray-500 mt-2">Manually add names to the wheel</p>
                </div>

                <div className="bg-white rounded-2xl shadow-2xl p-6">
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                      ğŸ‘¥ Participants <span className="text-sm font-normal text-gray-500">({names.length})</span>
                    </h2>
                    {names.length > 0 && (
                      <button
                        onClick={clearAll}
                        className="text-red-600 hover:text-red-700 transition text-sm font-semibold"
                        title="Clear all names"
                      >
                        ğŸ—‘ï¸ Clear
                      </button>
                    )}
                  </div>
                  <div className="max-h-96 overflow-y-auto space-y-2">
                    {names.length === 0 ? (
                      <div className="text-center py-8">
                        <p className="text-gray-400 text-sm mb-2">No participants yet</p>
                        {sheetUrl ? (
                          <p className="text-xs text-gray-500">Click "Refresh Names" to load from Google Sheets</p>
                        ) : (
                          <p className="text-xs text-gray-500">Click "Setup" to configure Google Sheets</p>
                        )}
                      </div>
                    ) : (
                      names.map((name, index) => (
                        <div
                          key={index}
                          className="flex justify-between items-center bg-gray-50 hover:bg-gray-100 px-3 py-2 rounded-lg transition"
                        >
                          <span className="text-gray-800 font-medium">{index + 1}. {name}</span>
                          <button
                            onClick={() => removeName(index)}
                            className="text-red-500 hover:text-red-700 transition text-xl font-bold"
                            title="Remove"
                          >
                            Ã—
                          </button>
                        </div>
                      ))
                    )}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<SpinTheWheel />, document.getElementById('root'));
  </script>
</body>
</html>

